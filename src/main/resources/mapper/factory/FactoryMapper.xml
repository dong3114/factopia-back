<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.factopia.factory.mapper.FactoryMapper">
    <!-- 공장 반환객체 -->
    <resultMap id="FactoryDataResponseMap" type="com.factopia.factory.domain.FactoryDataResponse">
        <association property="factorySite" javaType="com.factopia.factory.domain.FactorySite" resultMap="FactorySiteResultMap"/>
    </resultMap>

    <!-- 최상위 공장 사이트 결과 매핑 -->
    <resultMap id="FactorySiteResultMap" type="com.factopia.factory.domain.FactorySite">
        <id property="factoryNo" column="f_no"/>
        <result property="enterpriseNo" column="e_no"/>
        <result property="totalWidth" column="total_width"/>
        <result property="totalHeight" column="total_height"/>
        <result property="totalDepth" column="total_depth"/>
        <result property="createTime" column="created_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="factorySiteName" column="factory_site_name"/>
        <!-- 공장 구역 정보를 nested select로 로드 -->
        <collection property="factoryZones" ofType="com.factopia.factory.domain.FactoryZone"
                    select="factoryZonesLoad" column="f_no"/>
    </resultMap>

    <!-- 공장 구역 결과 매핑 -->
    <resultMap id="FactoryZoneResultMap" type="com.factopia.factory.domain.FactoryZone">
        <id property="factoryZoneNo" column="f_zone_no"/>
        <result property="factoryNo" column="f_no"/>
        <result property="xStart" column="fz_x_start"/>
        <result property="yStart" column="fz_y_start"/>
        <result property="zStart" column="fz_z_start"/>
        <result property="xEnd" column="fz_x_end"/>
        <result property="yEnd" column="fz_y_end"/>
        <result property="zEnd" column="fz_z_end"/>
        <result property="zoneDescription" column="zone_discription"/>
        <result property="createTime" column="fz_created_time"/>
        <result property="updateTime" column="fz_update_time"/>
        <!-- 공장 사용 구역 정보를 nested select로 로드 -->
        <collection property="factorySections" ofType="com.factopia.factory.domain.FactorySection"
                    select="factorySectionsLoad" column="f_zone_no"/>
    </resultMap>

    <!-- 공장 사용 구역 결과 매핑 -->
    <resultMap id="FactorySectionResultMap" type="com.factopia.factory.domain.FactorySection">
        <id property="factorySectionNo" column="f_section_no"/>
        <result property="factoryZoneNo" column="f_zone_no"/>
        <result property="xStart" column="fsn_x_start"/>
        <result property="yStart" column="fsn_y_start"/>
        <result property="zStart" column="fsn_z_start"/>
        <result property="xEnd" column="fsn_x_end"/>
        <result property="yEnd" column="fsn_y_end"/>
        <result property="zEnd" column="fsn_z_end"/>
        <result property="usedDescription" column="used_discription"/>
        <result property="createTime" column="fsn_created_time"/>
        <result property="updateTime" column="fsn_update_time"/>
        <!-- 3D 오브젝트 정보를 nested select로 로드 -->
        <collection property="object3DS" ofType="com.factopia.factory.domain.Object3D"
                    select="object3DsLoad" column="f_section_no"/>
    </resultMap>

    <!-- 3D 오브젝트 결과 매핑 -->
    <resultMap id="Object3DResultMap" type="com.factopia.factory.domain.Object3D">
        <id property="objectNo" column="object_no"/>
        <result property="factorySectionNo" column="f_section_no"/>
        <result property="xPosition" column="x_pos"/>
        <result property="yPosition" column="y_pos"/>
        <result property="zPosition" column="z_pos"/>
        <result property="xSize" column="x_size"/>
        <result property="ySize" column="y_size"/>
        <result property="zSize" column="z_size"/>
        <result property="color" column="color"/>
        <result property="classification" column="classification"/>
        <result property="geometryData" column="geometry"/>
        <result property="materialData" column="material"/>
        <result property="rotationX" column="rotation_x"/>
        <result property="rotationY" column="rotation_y"/>
        <result property="rotationZ" column="rotation_z"/>
    </resultMap>

    <!-- ✅ 기업이 가진 공장 코드 조회 -->
    <select id="getAllFactoryNo" parameterType="String" resultType="String">
        SELECT f_no
        FROM factory_site
        WHERE e_no = #{enterpriseNo}
    </select>

    <!-- ✅ 공장 정보 조회 -->
    <select id="factorySitesLoad" parameterType="String" resultMap="FactorySiteResultMap">
        SELECT
        f_no, e_no, total_width, total_height, total_depth,
        created_time, update_time, factory_site_name
        FROM factory_site
        WHERE e_no = #{enterpriseNo}
    </select>

    <!-- ✅ 특정 공장의 구역 정보 조회 -->
    <select id="factoryZonesLoad" parameterType="String" resultMap="FactoryZoneResultMap">
        SELECT
        f_zone_no, f_no, x_start, y_start, z_start, x_end, y_end, z_end,
        zone_discription, created_time, update_time
        FROM factory_zone
        WHERE f_no = #{factoryNo}
    </select>

    <!-- ✅ 특정 구역의 사용 구역 정보 조회 -->
    <select id="factorySectionsLoad" parameterType="String" resultMap="FactorySectionResultMap">
        SELECT
        f_section_no, f_zone_no, x_start, y_start, z_start,
        x_end, y_end, z_end, used_discription, created_time, update_time
        FROM factory_section
        WHERE f_zone_no = #{factoryZoneNo}
    </select>

    <!-- ✅ 특정 사용 구역의 3D 오브젝트 정보 조회 -->
    <select id="object3DsLoad" parameterType="String" resultMap="Object3DResultMap">
        SELECT
        object_no, f_section_no, x_pos, y_pos, z_pos,
        x_size, y_size, z_size, color, classification,
        geometry, material, rotation_x, rotation_y, rotation_z
        FROM object_3D
        WHERE f_section_no = #{factorySectionNo}
    </select>
</mapper>
